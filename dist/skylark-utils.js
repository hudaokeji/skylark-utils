/**
 * skylark-utils - An Elegant HTML5 JavaScript Library.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.5
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(t,e){function r(t,e){if("."!==t[0])return t;var r=e.split("/"),n=t.split("/");r.pop();for(var i=0;i<n.length;i++)"."!=n[i]&&(".."==n[i]?r.pop():r.push(n[i]));return r.join("/")}var n=e.define,i=e.require,s="function"==typeof n&&n.amd,a=!s&&"undefined"!=typeof exports;if(!s&&!n){var o={};n=e.define=function(t,e,n){"function"==typeof n?(o[t]={factory:n,deps:e.map(function(e){return r(e,t)}),exports:null},i(t)):o[t]=n},i=e.require=function(t){if(!o.hasOwnProperty(t))throw new Error("Module "+t+" has not been defined");var e=o[t];if(!e.exports){var r=[];e.deps.forEach(function(t){r.push(i(t))}),e.exports=e.factory.apply(window,r)}return e.exports}}if(!n)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(t(n,i),!s){var l=i("skylark-langx/skylark");a?exports=l:e.skylarkjs=l}}(function(t,e){t("skylark-utils/skylark",["skylark-langx/skylark"],function(t){return t}),t("skylark-utils/browser",["skylark-utils-dom/browser"],function(t){return t}),t("skylark-utils/css",["skylark-utils-dom/css"],function(t){return t}),t("skylark-utils/datax",["skylark-utils-dom/datax"],function(t){return t}),t("skylark-utils/langx",["skylark-langx/langx"],function(t){return t}),t("skylark-utils/noder",["skylark-utils-dom/noder"],function(t){return t}),t("skylark-utils/finder",["skylark-utils-dom/finder"],function(t){return t}),t("skylark-utils/geom",["skylark-utils-dom/geom"],function(t){return t}),t("skylark-utils/eventer",["skylark-utils-dom/eventer"],function(t){return t}),t("skylark-utils/styler",["./skylark","./langx"],function(t,e){function r(t,e){return"number"!=typeof e||y[v(t)]?e:e+"px"}function n(t){return t in _?_[t]:_[t]=new RegExp("(^|\\s)"+t+"(\\s|$)")}function i(t,e){var r=t.className||"",n=r&&void 0!==r.baseVal;return void 0===e?n?r.baseVal:r:void(n?r.baseVal=e:t.className=e)}function s(t,e){return arguments.length<2?!!this.dom.disabled:(t.disabled=e,this)}function a(t){var e,r;return k[t]||(e=document.createElement(t),document.body.appendChild(e),r=getComputedStyle(e,"").getPropertyValue("display"),e.parentNode.removeChild(e),"none"==r&&(r="block"),k[t]=r),k[t]}function o(t){return E.css(t,"display",""),"none"==E.css(t,"display")&&E.css(t,"display",a(t.nodeName)),this}function l(t){return"none"==E.css(t,"display")||0==E.css(t,"opacity")}function u(t){return E.css(t,"display","none"),this}function c(t,r){if(!r)return this;var s,a=i(t);return s=e.isString(r)?r.split(/\s+/g):r,s.forEach(function(t){var e=n(t);a.match(e)||(a+=(a?" ":"")+t)}),i(t,a),this}function d(t,n,i){if(arguments.length<3){var s,s=getComputedStyle(t,"");if(e.isString(n))return t.style[m(n)]||s.getPropertyValue(v(n));if(e.isArrayLike(n)){var a={};return p.call(n,function(e){a[e]=t.style[m(e)]||s.getPropertyValue(v(e))}),a}}var o="";if("string"==typeof n)i||0===i?o=v(n)+":"+r(n,i):t.style.removeProperty(v(n));else for(key in n)void 0!==n[key]&&(n[key]||0===n[key]?o+=v(key)+":"+r(key,n[key])+";":t.style.removeProperty(v(key)));return t.style.cssText+=";"+o,this}function h(t,e){var r=n(e);return t.className&&t.className.match(r)}function f(t,r){if(r){var s,a=i(t);s=e.isString(r)?r.split(/\s+/g):r,s.forEach(function(t){var e=n(t);a.match(e)&&(a=a.replace(e," "))}),i(t,a.trim())}else i(t,"");return this}function g(t,e,r){var n=this;return e.split(/\s+/g).forEach(function(e){void 0===r&&(r=!n.hasClass(t,e)),r?n.addClass(t,e):n.removeClass(t,e)}),n}var p=(Array.prototype.every,Array.prototype.forEach),m=e.camelCase,v=e.dasherize,y={"column-count":1,columns:1,"font-weight":1,"line-height":1,opacity:1,"z-index":1,zoom:1},_={},k={},E=function(){return E};return e.mixin(E,{autocssfix:!1,cssHooks:{},addClass:c,className:i,css:d,disabled:s,hasClass:h,hide:u,isInvisible:l,removeClass:f,show:o,toggleClass:g}),t.styler=E}),t("skylark-utils/dnd",["./skylark","./langx","./noder","./datax","./finder","./geom","./eventer","./styler"],function(t,e,r,n,i,s,a,o){function l(t,e){return new f(t,e)}function u(t,e){return new g(t,e)}function c(){return c}var d=(a.on,a.off,n.attr,n.removeAttr,s.pagePosition,o.addClass,s.height,e.Evented.inherit({klassName:"DndManager",init:function(){},prepare:function(t){var e=a.create("preparing",{dragSource:t.dragSource,dragHandle:t.dragHandle});t.trigger(e),t.dragSource=e.dragSource},start:function(t,r){var n=s.pagePosition(t.dragSource);this.draggingOffsetX=parseInt(r.pageX-n.left),this.draggingOffsetY=parseInt(r.pageY-n.top);var i=a.create("started",{elm:t.elm,dragSource:t.dragSource,dragHandle:t.dragHandle,ghost:null,transfer:{}});t.trigger(i),this.dragging=t,t.draggingClass&&o.addClass(t.dragSource,t.draggingClass),this.draggingGhost=i.ghost,this.draggingGhost||(this.draggingGhost=t.elm),this.draggingTransfer=i.transfer,this.draggingTransfer&&e.each(this.draggingTransfer,function(t,e){r.dataTransfer.setData(t,e)}),r.dataTransfer.setDragImage(this.draggingGhost,this.draggingOffsetX,this.draggingOffsetY),r.dataTransfer.effectAllowed="copyMove";var l=a.create("dndStarted",{elm:i.elm,dragSource:i.dragSource,dragHandle:i.dragHandle,ghost:i.ghost,transfer:i.transfer});this.trigger(l)},over:function(){},end:function(t){var e=this.dragging;e&&e.draggingClass&&o.removeClass(e.dragSource,e.draggingClass);var r=a.create("dndEnded",{});this.trigger(r),this.dragging=null,this.draggingTransfer=null,this.draggingGhost=null,this.draggingOffsetX=null,this.draggingOffsetY=null}})),h=new d,f=e.Evented.inherit({klassName:"Draggable",init:function(t,r){var s=this;s.elm=t,s.draggingClass=r.draggingClass||"dragging",s.params=e.clone(r),["preparing","started","ended","moving"].forEach(function(t){e.isFunction(r[t])&&s.on(t,r[t])}),a.on(t,{mousedown:function(t){var e=s.params;e.handle&&(s.dragHandle=i.closest(t.target,e.handle),!s.dragHandle)||(e.source?s.dragSource=i.closest(t.target,e.source):s.dragSource=s.elm,h.prepare(s),s.dragSource&&n.attr(s.dragSource,"draggable","true"))},mouseup:function(t){s.dragSource&&(s.dragSource=null,s.dragHandle=null)},dragstart:function(t){n.attr(s.dragSource,"draggable","false"),h.start(s,t)},dragend:function(t){a.stop(t),h.dragging&&h.end(!1)}})}}),g=e.Evented.inherit({klassName:"Droppable",init:function(t,r){var n,i,s=this,l=(r.draggingClass||"dragging",!0);s.elm=t,s._params=r,["started","entered","leaved","dropped","overing"].forEach(function(t){e.isFunction(r[t])&&s.on(t,r[t])}),a.on(t,{dragover:function(t){if(t.stopPropagation(),l){var e=a.create("overing",{overElm:t.target,transfer:h.draggingTransfer,acceptable:!0});s.trigger(e),e.acceptable&&(t.preventDefault(),t.dataTransfer.dropEffect="copyMove")}},dragenter:function(t){var e=(s._params,s.elm),r=a.create("entered",{transfer:h.draggingTransfer});s.trigger(r),t.stopPropagation(),n&&l&&o.addClass(e,n)},dragleave:function(t){var e=(s._params,s.elm);if(!l)return!1;var r=a.create("leaved",{transfer:h.draggingTransfer});s.trigger(r),t.stopPropagation(),n&&l&&o.removeClass(e,n)},drop:function(t){var e=(s._params,s.elm);if(a.stop(t),h.dragging){n&&l&&o.addClass(e,n);var r=a.create("dropped",{transfer:h.draggingTransfer});s.trigger(r),h.end(!0)}}}),h.on("dndStarted",function(e){var r=a.create("started",{transfer:h.draggingTransfer,acceptable:!1});s.trigger(r),l=r.acceptable,n=r.hoverClass,i=r.activeClass,i&&l&&o.addClass(t,i)}).on("dndEnded",function(e){var r=a.create("ended",{transfer:h.draggingTransfer,acceptable:!1});s.trigger(r),n&&l&&o.removeClass(t,n),i&&l&&o.removeClass(t,i),l=!1,i=null,n=null})}});return e.mixin(c,{draggable:l,droppable:u,manager:h}),t.dnd=c}),t("skylark-utils/_devices/usermedia",["../langx"],function(t){function e(){return e}navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var r=t.Deferred,n=null;return t.mixin(e,{isSupported:function(){return!!navigator.getUserMedia},start:function(t,e){var i=new r;return navigator.getUserMedia({video:!0,audio:!0},function(e){n=e,t.src=window.URL.createObjectURL(localMediaStream),t.onloadedmetadata=function(t){},i.resolve()},function(t){i.reject(t)}),i.promise},stop:function(){n&&(n.stop(),n=null)}}),e}),t("skylark-utils/_devices/vibrate",["../langx"],function(t){function e(){return e}return navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate,t.mixin(e,{isSupported:function(){return!!navigator.vibrate},start:function(t){navigator.vibrate(t)},stop:function(){navigator.vibrate(0)}}),e}),t("skylark-utils/devices",["./skylark","./langx","./_devices/usermedia","./_devices/vibrate"],function(t,e,r,n){function i(){return i}return e.mixin(i,{usermedia:r,vibrate:n}),t.devices=i}),t("skylark-utils/filer",["./skylark","./langx","./datax","./eventer","./styler"],function(t,e,r,n,i){function s(t,r){r=r||{};var s=r.hoverClass||"dropzone",a=r.dropped,o=0;return h(t,"dragenter",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&(n.stop(e),o++,i.addClass(t,s))}),h(t,"dragover",function(t){t.dataTransfer&&t.dataTransfer.types.indexOf("Files")>-1&&n.stop(t)}),h(t,"dragleave",function(e){e.dataTransfer&&e.dataTransfer.types.indexOf("Files")>-1&&(o--,0==o&&i.removeClass(t,s))}),h(t,"drop",function(r){if(r.dataTransfer&&r.dataTransfer.types.indexOf("Files")>-1&&(i.removeClass(t,s),n.stop(r),a)){var o=r.dataTransfer.items;o&&o.length&&(o[0].webkitGetAsEntry||o[0].getAsEntry)?p.all(e.map(o,function(t){return t.webkitGetAsEntry?t.webkitGetAsEntry():t.getAsEntry()})).then(a):a(r.dataTransfer.files)}}),this}function a(t,r){r=r||{};var n=(r.hoverClass||"pastezone",r.pasted);return h(t,"paste",function(t){var r=t.originalEvent&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items,i=[];r&&r.length&&e.each(r,function(t,e){var r=e.getAsFile&&e.getAsFile();r&&i.push(r)}),n&&i.length&&n(i)}),this}function o(t,e){return h(t,"click",function(t){t.preventDefault(),l(e)}),this}function l(t){function e(t){for(var e=t.length;e--;)t[e].size>g&&t.splice(e,1);i(t)}t=t||{};var r=t.directory||!1,n=t.multiple||!1,i=t.picked;if(!c){var s=c=document.createElement("input");s.type="file",s.style.position="fixed",s.style.left=0,s.style.top=0,s.style.opacity=.001,document.body.appendChild(s),s.onchange=function(t){var r=t.target.webkitEntries||t.target.entries;r&&r.length?p.all(r).then(function(t){e(t)}):e(Array.prototype.slice.call(t.target.files)),s.value=""}}c.multiple=n,c.webkitdirectory=r,c.click()}function u(t){function r(t){t.type=t.type||"POST",a(t,!0)||t.data||n(t)}function n(t){var r,n=t.files[0],i=t.multipart,s="array"===e.type(t.paramName)?t.paramName[0]:t.paramName;t.headers=e.mixin({},t.headers),t.contentRange&&(t.headers["Content-Range"]=t.contentRange),i?(r=new FormData,t.blob?r.append(s,t.blob,n.name):e.each(t.files,function(n,i){r.append("array"===e.type(t.paramName)&&t.paramName[n]||s,i,i.uploadName||i.name)}),t.data=r):(t.headers["Content-Disposition"]='attachment; filename="'+encodeURI(n.name)+'"',t.contentType=n.type||"application/octet-stream",t.data=t.blob||n),t.blob=null}function i(t){var e=t.getResponseHeader("Range"),r=e&&e.split("-"),n=r&&r.length>1&&parseInt(r[1],10);return n&&n+1}function s(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0,this.getBitrate=function(t,e,r){var n=t-this.timestamp;return(!this.bitrate||!r||n>r)&&(this.bitrate=(e-this.loaded)*(1e3/n)*8,this.loaded=e,this.timestamp=t),this.bitrate}}function a(t,r){t.uploadedBytes=t.uploadedBytes||0;var s,a,o=t.files[0],u=o.size,c=t.uploadedBytes,d=t.maxChunkSize||u,h=l,g=new f,p=g.promise;return!(!h||!(c||d<u)||t.data)&&(!!r||(c>=u?(o.error=t.i18n("uploadedBytes"),this._getXHRPromise(!1,t.context,[null,"error",o.error])):(a=function(){var r=e.mixin({},t),l=r._progress.loaded;r.blob=h.call(o,c,c+d,o.type),r.chunkSize=r.blob.size,r.contentRange="bytes "+c+"-"+(c+r.chunkSize-1)+"/"+u,n(r),s=$.ajax(r).done(function(e,n,s){c=i(s)||c+r.chunkSize,l+r.chunkSize-r._progress.loaded&&g.progress({lengthComputable:!0,loaded:c-r.uploadedBytes,total:c-r.uploadedBytes}),t.uploadedBytes=r.uploadedBytes=c,r.result=e,r.textStatus=n,r.jqXHR=s,c<u?a():g.resolveWith(r.context,[e,n,s])}).fail(function(t,e,n){r.jqXHR=t,r.textStatus=e,r.errorThrown=n,g.rejectWith(r.context,[t,e,n])})},p.abort=function(){return s.abort()},a(),p)))}var o=e.mixin({contentRange:null,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,limitMultiFileUploadSize:void 0,limitMultiFileUploadSizeOverhead:512,sequentialUploads:!1,limitConcurrentUploads:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!0,messages:{uploadedBytes:"Uploaded bytes exceed file size"},i18n:function(t,r){return t=this.messages[t]||t.toString(),r&&e.each(r,function(e,r){t=t.replace("{"+e+"}",r)}),t},formData:function(t){return t.serializeArray()},add:function(t,e){return!t.isDefaultPrevented()&&void((e.autoUpload||e.autoUpload!==!1&&$(this).fileupload("option","autoUpload"))&&e.process().done(function(){e.submit()}))},processData:!1,contentType:!1,cache:!1},t),l=function(){var t=Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice;return t.apply(this,arguments)},u=function(t){return e.Xhr.request(t.url,t)};r(o),o._bitrateTimer=new s;var c=a(o)||u(o);return c.options=o,c}var c,d=Array.prototype.concat,h=n.on,f=(n.attr,e.Deferred),g=1/0,p=function(){function t(t,e){var n=new f,i=function(t){n.reject(t)};if(e=e||"",t.isFile)t.file(function(t){t.relativePath=e,n.resolve(t)},i);else if(t.isDirectory){var s=t.createReader();s.readEntries(function(s){r(s,e+t.name+"/").then(function(t){n.resolve(t)})["catch"](i)},i)}else n.resolve([]);return n.promise}function r(r,n){return f.all(e.map(r,function(e){return t(e,n)})).then(function(){return d.apply([],arguments)})}return{one:t,all:r}}(),m=function(){return m};return e.mixin(m,{dropzone:s,pastezone:a,picker:o,select:l,upload:u,readFile:function(t,e){e=e||{};var r=new f,n=new FileReader;return n.onload=function(t){r.resolve(t.target.result)},n.onerror=function(t){var e=t.target.error.code;2===e?alert("please don't open this page using protocol fill:///"):alert("error code: "+e)},e.asArrayBuffer?n.readAsArrayBuffer(t):e.asDataUrl?n.readAsDataURL(t):e.asText?n.readAsText(t):n.readAsArrayBuffer(t),r.promise},writeFile:function(t,r){if(window.navigator.msSaveBlob)e.isString(t)&&(t=dataURItoBlob(t)),window.navigator.msSaveBlob(t,r);else{var n=document.createElement("a");t instanceof Blob&&(t=e.URL.createObjectURL(t)),n.href=t,n.setAttribute("download",r||"noname"),n.dispatchEvent(new CustomEvent("click"))}}}),t.filer=m}),t("skylark-utils/fx",["skylark-utils-dom/fx"],function(t){return t}),t("skylark-utils/images",["skylark-utils-dom/images"],function(t){return t}),t("skylark-utils/models",["./skylark","./langx"],function(t,e){function r(){return r}var n={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"},i=function(t,i,s){var a=n[t];e.defaults(s||(s={}),{emulateHTTP:r.emulateHTTP,emulateJSON:r.emulateJSON});var o={type:a,dataType:"json"};if(s.url||(o.url=e.result(i,"url")||urlError()),null!=s.data||!i||"create"!==t&&"update"!==t&&"patch"!==t||(o.contentType="application/json",o.data=JSON.stringify(s.attrs||i.toJSON(s))),s.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{entity:o.data}:{}),s.emulateHTTP&&("PUT"===a||"DELETE"===a||"PATCH"===a)){o.type="POST",s.emulateJSON&&(o.data._method=a);var l=s.beforeSend;s.beforeSend=function(t){if(t.setRequestHeader("X-HTTP-Method-Override",a),l)return l.apply(this,arguments)}}"GET"===o.type||s.emulateJSON||(o.processData=!1);var u=s.error;s.error=function(t,e,r){s.textStatus=e,s.errorThrown=r,u&&u.call(s.context,t,e,r)};var c=s.xhr=e.Xhr.request(e.mixin(o,s));return i.trigger("request",i,c,s),c},s=e.Stateful.inherit({sync:function(){return r.sync.apply(this,arguments)},matches:function(t){return e.isMatch(this.attributes,t)},fetch:function(t){t=e.mixin({parse:!0},t);var r=this,n=t.success;return t.success=function(e){var i=t.parse?r.parse(e,t):e;return!!r.set(i,t)&&(n&&n.call(t.context,r,e,t),void r.trigger("sync",r,e,t))},wrapError(this,t),this.sync("read",this,t)},save:function(t,r,n){var i;null==t||"object"==typeof t?(i=t,n=r):(i={})[t]=r,n=e.mixin({validate:!0,parse:!0},n);var s=n.wait;if(i&&!s){if(!this.set(i,n))return!1}else if(!this._validate(i,n))return!1;var a=this,o=n.success,l=this.attributes;n.success=function(t){a.attributes=l;var r=n.parse?a.parse(t,n):t;return s&&(r=e.mixin({},i,r)),!(r&&!a.set(r,n))&&(o&&o.call(n.context,a,t,n),void a.trigger("sync",a,t,n))},wrapError(this,n),i&&s&&(this.attributes=e.mixin({},l,i));var u=this.isNew()?"create":n.patch?"patch":"update";"patch"!==u||n.attrs||(n.attrs=i);var c=this.sync(u,this,n);return this.attributes=l,c},destroy:function(t){t=t?e.clone(t):{};var r=this,n=t.success,i=t.wait,s=function(){r.stopListening(),r.trigger("destroy",r,r.collection,t)};t.success=function(e){i&&s(),n&&n.call(t.context,r,e,t),r.isNew()||r.trigger("sync",r,e,t)};var a=!1;return this.isNew()?e.defer(t.success):(wrapError(this,t),a=this.sync("delete",this,t)),i||s(),a},url:function(){var t=e.result(this,"urlRoot")||e.result(this.collection,"url")||urlError();if(this.isNew())return t;var r=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(r)},parse:function(t,e){return t}}),a=e.Evented.inherit({init:function(t,r){r||(r={}),r.entity&&(this.entity=r.entity),void 0!==r.comparator&&(this.comparator=r.comparator),this._reset(),t&&this.reset(t,e.mixin({silent:!0},r))}}),o={add:!0,remove:!0,merge:!0},l={add:!0,remove:!1},u=function(t,e,r){r=Math.min(Math.max(r,0),t.length);var n,i=Array(t.length-r),s=e.length;for(n=0;n<i.length;n++)i[n]=t[n+r];for(n=0;n<s;n++)t[n+r]=e[n];for(n=0;n<i.length;n++)t[n+s+r]=i[n]};return a.partial({entity:s,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return r.sync.apply(this,arguments)},add:function(t,r){return this.set(t,e.mixin({merge:!1},r,l))},remove:function(t,r){r=e.mixin({},r);var n=!e.isArray(t);t=n?[t]:t.slice();var i=this._removeEntitys(t,r);return!r.silent&&i.length&&(r.changes={added:[],merged:[],removed:i},this.trigger("update",this,r)),n?i[0]:i},set:function(t,r){if(null!=t){r=e.mixin({},o,r),r.parse&&!this._isEntity(t)&&(t=this.parse(t,r)||[]);var n=!e.isArray(t);t=n?[t]:t.slice();var i=r.at;null!=i&&(i=+i),i>this.length&&(i=this.length),i<0&&(i+=this.length+1);var s,a,l=[],c=[],d=[],h=[],f={},g=r.add,p=r.merge,m=r.remove,v=!1,y=this.comparator&&null==i&&r.sort!==!1,_=e.isString(this.comparator)?this.comparator:null;for(a=0;a<t.length;a++){s=t[a];var k=this.get(s);if(k){if(p&&s!==k){var E=this._isEntity(s)?s.attributes:s;r.parse&&(E=k.parse(E,r)),k.set(E,r),d.push(k),y&&!v&&(v=k.hasChanged(_))}f[k.cid]||(f[k.cid]=!0,l.push(k)),t[a]=k}else g&&(s=t[a]=this._prepareEntity(s,r),s&&(c.push(s),this._addReference(s,r),f[s.cid]=!0,l.push(s)))}if(m){for(a=0;a<this.length;a++)s=this.entities[a],f[s.cid]||h.push(s);h.length&&this._removeEntitys(h,r)}var b=!1,w=!y&&g&&m;if(l.length&&w?(b=this.length!==l.length||this.entities.some(function(t,e){return t!==l[e]}),this.entities.length=0,u(this.entities,l,0),this.length=this.entities.length):c.length&&(y&&(v=!0),u(this.entities,c,null==i?this.length:i),this.length=this.entities.length),v&&this.sort({silent:!0}),!r.silent){for(a=0;a<c.length;a++)null!=i&&(r.index=i+a),s=c[a],s.trigger("add",s,this,r);(v||b)&&this.trigger("sort",this,r),(c.length||h.length||d.length)&&(r.changes={added:c,removed:h,merged:d},this.trigger("update",this,r))}return n?t[0]:t}},reset:function(t,r){r=r?e.clone(r):{};for(var n=0;n<this.entities.length;n++)this._removeReference(this.entities[n],r);return r.previousEntitys=this.entities,this._reset(),t=this.add(t,e.mixin({silent:!0},r)),r.silent||this.trigger("reset",this,r),t},push:function(t,r){return this.add(t,e.mixin({at:this.length},r))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(t,r){return this.add(t,e.mixin({at:0},r))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.entities,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.entityId(t.attributes||t)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.entities[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(t){var r=this.comparator;if(!r)throw new Error("Cannot sort a set without a comparator");t||(t={});var n=r.length;return e.isFunction(r)&&(r=e.proxy(r,this)),1===n||e.isString(r)?this.entities=this.sortBy(r):this.entities.sort(r),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return this.map(t+"")},fetch:function(t){t=e.mixin({parse:!0},t);var r=t.success,n=this;return t.success=function(e){var i=t.reset?"reset":"set";n[i](e,t),r&&r.call(t.context,n,e,t),n.trigger("sync",n,e,t)},wrapError(this,t),this.sync("read",this,t)},create:function(t,r){r=r?e.clone(r):{};var n=r.wait;if(t=this._prepareEntity(t,r),!t)return!1;n||this.add(t,r);var i=this,s=r.success;return r.success=function(t,e,r){n&&i.add(t,r),s&&s.call(r.context,t,e,r)},t.save(null,r),t},parse:function(t,e){return t},clone:function(){return new this.constructor(this.entities,{entity:this.entity,comparator:this.comparator})},entityId:function(t){return t[this.entity.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.entities=[],this._byId={}},_prepareEntity:function(t,r){if(this._isEntity(t))return t.collection||(t.collection=this),t;r=r?e.clone(r):{},r.collection=this;var n=new this.entity(t,r);return n.validationError?(this.trigger("invalid",this,n.validationError,r),!1):n},_removeEntitys:function(t,e){for(var r=[],n=0;n<t.length;n++){var i=this.get(t[n]);if(i){var s=this.indexOf(i);this.entities.splice(s,1),this.length--,delete this._byId[i.cid];var a=this.entityId(i.attributes);null!=a&&delete this._byId[a],e.silent||(e.index=s,i.trigger("remove",i,this,e)),r.push(i),this._removeReference(i,e)}}return r},_isEntity:function(t){return t instanceof s},_addReference:function(t,e){this._byId[t.cid]=t;var r=this.entityId(t.attributes);null!=r&&(this._byId[r]=t),t.on("all",this._onEntityEvent,this)},_removeReference:function(t,e){delete this._byId[t.cid];var r=this.entityId(t.attributes);null!=r&&delete this._byId[r],this===t.collection&&delete t.collection,t.off("all",this._onEntityEvent,this)},_onEntityEvent:function(t,e,r,n){if(e){if(("add"===t||"remove"===t)&&r!==this)return;if("destroy"===t&&this.remove(e,n),"change"===t){var i=this.entityId(e.previousAttributes()),s=this.entityId(e.attributes);i!==s&&(null!=i&&delete this._byId[i],null!=s&&(this._byId[s]=e))}}this.trigger.apply(this,arguments)}}),e.mixin(r,{emulateHTTP:!1,emulateJSON:!1,sync:i,Entity:s,Collection:a}),t.models=r}),t("skylark-utils/query",["skylark-utils-dom/query"],function(t){return t}),t("skylark-utils/scripter",["skylark-utils-dom/scripter"],function(t){return t}),t("skylark-utils/_storages/cookies",["../langx"],function(t){function e(){return e}return t.mixin(e,{get:function(t){return sKey&&this.has(t)?unescape(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1")):null},has:function(t){return new RegExp("(?:^|;\\s*)"+escape(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},list:function(){for(var t=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),e=0;e<t.length;e++)t[e]=unescape(t[e]);return t},remove:function(t,e){t&&this.has(t)&&(document.cookie=escape(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(e?"; path="+e:""))},set:function(t,e,r,n,i,s){if(t&&!/^(?:expires|max\-age|path|domain|secure)$/i.test(t)){var a="";if(r)switch(r.constructor){case Number:a=vEnd===1/0?"; expires=Tue, 19 Jan 2038 03:14:07 GMT":"; max-age="+r;break;case String:a="; expires="+r;break;case Date:a="; expires="+r.toGMTString()}document.cookie=escape(t)+"="+escape(e)+a+(i?"; domain="+i:"")+(n?"; path="+n:"")+(s?"; secure":"")}}}),e}),t("skylark-utils/_storages/localfs",["../langx"],function(t){function e(t){var e="";switch(t.code){case FileError.QUOTA_EXCEEDED_ERR:e="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:e="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:e="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:e="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:e="INVALID_STATE_ERR";break;default:e="Unknown Error"}return e}function r(){return r}var n=t.Deferred,i=window.requestFileSystem||window.webkitRequestFileSystem,s=(window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL,window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder,t.Evented.inherit({_fs:null,_isPersisted:!0,_cwd:null,init:function(t){this._fs=t,this._cwd=t.root},readfileAsArrayBuffer:function(t,e,r){this._cwd.getFile(t,{},function(t){t.file(function(t){var r=new FileReader;r.onloadend=function(){e(null,this.result)},r.readAsArrayBuffer(t)},r)},r)},readfileAsDataURL:function(t,e,r){this._cwd.getFile(t,{},function(t){t.file(function(t){var r=new FileReader;r.onloadend=function(){e(null,this.result)},r.readAsDataURL(t)},r)},r)},readfileAsText:function(t,e,r){this._cwd.getFile(t,{},function(t){t.file(function(t){var r=new FileReader;r.onloadend=function(){e(null,this.result)},r.readAsText(t)},r)},r)},writefile:function(t,e,r,n){var i=this,s=t.split("/");s=s.slice(0,s.length-1),this.mkdir(s.join("/"),function(){i._cwd.getFile(t,{create:!0},function(t){t.createWriter(function(t){var i=!1;t.onwriteend=function(){return i?void(r&&r()):(i=!0,void this.truncate(this.position))},t.onerror=n;var s=e;!s instanceof Blob&&(s=new Blob([e],{type:"text/plain"})),t.write(s)},n)},n)})},rmfile:function(t,e,r){this._cwd.getFile(t,{},function(t){t.remove(function(){e()},r)},r)},readdir:function(t,e,r){this._cwd.getDirectory(t,{},function(t){function n(){i.readEntries(function(t){t.length?(s=s.concat(Array.prototype.slice.call(t).map(function(t){return t.name+(t.isDirectory?"/":"")})),n()):e(null,s)},r)}var i=t.createReader(),s=[];n()},r)},mkdir:function(t,e,r){var n=t.split("/"),i=function(s,a){return"."!=a[0]&&""!=a[0]||(a=a.slice(1)),0==a.length?void e(s):void s.getDirectory(a[0],{create:!0,exclusive:!1},function(s){if(s.isDirectory)a.length&&1!=n.length?i(s,a.slice(1)):e&&e(s);else{var o=new Error(t+" is not a directory");if(!r)throw o;r(o)}},function(t){if(!r)throw t;r(t)})};i(this._cwd,n)},rmdir:function(t,e,r){this._cwd.getDirectory(t,{},function(t){t.removeRecursively(function(){e()},r)},r)},copy:function(t,e,r){this._cwd.getFile(t,{},function(t){cwd.getDirectory(e,{},function(e){t.copyTo(e,function(){r()},r)},r)},r)},move:function(t,e,r){this._cwd.getFile(t,{},function(t){cwd.getDirectory(e,{},function(e){t.moveTo(e,function(){r()},r)},r)},r)},chdir:function(t,e){this._cwd.getDirectory(t,{},function(t){cwd=t,fs.onchdir&&fs.onchdir(cwd.fullPath),e()},e)},importFromHost:function(t){for(var r,i=new n,s=0;r=t[s];++s)!function(t){cwd.getFile(r.name,{create:!0,exclusive:!0},function(r){r.createWriter(function(e){e.write(t)},e)},e)}(r);return i.promise},exportToHost:function(){}}));return t.mixin(r,{isSupported:function(){return!!i},request:function(t,e){t=t||10485760;var r=e?PERSISTENT:TEMPORARY,a=new n;return i(r,t,function(t){var r=new s(t,(!!e));a.resolve(r)},function(t){a.reject(t)}),a.promise},FileSystem:s}),r}),t("skylark-utils/_storages/localStorage",["../langx"],function(t){function e(){return e}var r=null;try{r=window.localStorage}catch(n){}return t.mixin(e,{isSupported:function(){return!!r},set:function(e,n){return void 0===n?this.remove(e):(r.setItem(e,t.serializeValue(n)),n)},get:function(e,n){var i=t.deserializeValue(r.getItem(e));return void 0===i?n:i},remove:function(t){r.removeItem(t)},clear:function(){r.clear()},forEach:function(t){for(var e=0;e<r.length;e++){var n=r.key(e);t(n,store.get(n))}}}),e}),t("skylark-utils/_storages/sessionStorage",["../langx"],function(t){function e(){return e}var r=null;try{r=window.sessiionStorage}catch(n){}return t.mixin(e,{isSupported:function(){return!!r},set:function(e,n){return void 0===n?this.remove(e):(r.setItem(e,t.serializeValue(n)),n)},get:function(e,n){var i=t.deserializeValue(r.getItem(e));return void 0===i?n:i},remove:function(t){r.removeItem(t)},clear:function(){r.clear()},forEach:function(t){for(var e=0;e<r.length;e++){var n=r.key(e);t(n,store.get(n))}}}),e}),t("skylark-utils/storages",["./skylark","./langx","./_storages/cookies","./_storages/localfs","./_storages/localStorage","./_storages/sessionStorage"],function(t,e,r,n,i,s){function a(){return a}return e.mixin(a,{cookies:r,localfs:n,localStorage:i,sessionStorage:s}),t.storages=a}),t("skylark-utils/touchx",[],function(){var t=function(){function t(){this._dropEffect="move",this._effectAllowed="all",this._data={}}return Object.defineProperty(t.prototype,"dropEffect",{get:function(){return this._dropEffect},set:function(t){this._dropEffect=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"effectAllowed",{get:function(){return this._effectAllowed},set:function(t){this._effectAllowed=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"types",{get:function(){return Object.keys(this._data)},enumerable:!0,configurable:!0}),t.prototype.clearData=function(t){null!=t?delete this._data[t]:this._data=null},t.prototype.getData=function(t){return this._data[t]||""},t.prototype.setData=function(t,e){this._data[t]=e},t.prototype.setDragImage=function(t,r,n){var i=e._instance;i._imgCustom=t,i._imgOffset={x:r,y:n}},t}(),e=function(){function e(){if(this._lastClick=0,e._instance)throw"DragDropTouch instance already created.";var t=!1;if(document.addEventListener("test",null,{get passive(){return t=!0,!0}}),"ontouchstart"in document){var r=document,n=this._touchstart.bind(this),i=this._touchmove.bind(this),s=this._touchend.bind(this),a=!!t&&{passive:!1,capture:!1};r.addEventListener("touchstart",n,a),r.addEventListener("touchmove",i,a),r.addEventListener("touchend",s),r.addEventListener("touchcancel",s)}}return e.getInstance=function(){return e._instance},e.prototype._touchstart=function(t){var r=this;if(this._shouldHandle(t)){if(Date.now()-this._lastClick<e._DBLCLICK&&this._dispatchEvent(t,"dblclick",t.target))return t.preventDefault(),void this._reset();this._reset();var n=this._closestDraggable(t.target);n&&(this._dispatchEvent(t,"mousemove",t.target)||this._dispatchEvent(t,"mousedown",t.target)||(this._dragSource=n,this._ptDown=this._getPoint(t),this._lastTouch=t,t.preventDefault(),setTimeout(function(){r._dragSource==n&&null==r._img&&r._dispatchEvent(t,"contextmenu",n)&&r._reset()},e._CTXMENU)))}},e.prototype._touchmove=function(t){if(this._shouldHandle(t)){var r=this._getTarget(t);if(this._dispatchEvent(t,"mousemove",r))return this._lastTouch=t,void t.preventDefault();if(this._dragSource&&!this._img){var n=this._getDelta(t);n>e._THRESHOLD&&(this._dispatchEvent(t,"dragstart",this._dragSource),this._createImage(t),this._dispatchEvent(t,"dragenter",r))}this._img&&(this._lastTouch=t,t.preventDefault(),r!=this._lastTarget&&(this._dispatchEvent(this._lastTouch,"dragleave",this._lastTarget),this._dispatchEvent(t,"dragenter",r),this._lastTarget=r),this._moveImage(t),this._dispatchEvent(t,"dragover",r))}},e.prototype._touchend=function(t){if(this._shouldHandle(t)){if(this._dispatchEvent(this._lastTouch,"mouseup",t.target))return void t.preventDefault();this._img||(this._dragSource=null,this._dispatchEvent(this._lastTouch,"click",t.target),this._lastClick=Date.now()),this._destroyImage(),this._dragSource&&(t.type.indexOf("cancel")<0&&this._dispatchEvent(this._lastTouch,"drop",this._lastTarget),this._dispatchEvent(this._lastTouch,"dragend",this._dragSource),this._reset())}},e.prototype._shouldHandle=function(t){return t&&!t.defaultPrevented&&t.touches&&t.touches.length<2},e.prototype._reset=function(){
this._destroyImage(),this._dragSource=null,this._lastTouch=null,this._lastTarget=null,this._ptDown=null,this._dataTransfer=new t},e.prototype._getPoint=function(t,e){return t&&t.touches&&(t=t.touches[0]),{x:e?t.pageX:t.clientX,y:e?t.pageY:t.clientY}},e.prototype._getDelta=function(t){var e=this._getPoint(t);return Math.abs(e.x-this._ptDown.x)+Math.abs(e.y-this._ptDown.y)},e.prototype._getTarget=function(t){for(var e=this._getPoint(t),r=document.elementFromPoint(e.x,e.y);r&&"none"==getComputedStyle(r).pointerEvents;)r=r.parentElement;return r},e.prototype._createImage=function(t){this._img&&this._destroyImage();var r=this._imgCustom||this._dragSource;if(this._img=r.cloneNode(!0),this._copyStyle(r,this._img),this._img.style.top=this._img.style.left="-9999px",!this._imgCustom){var n=r.getBoundingClientRect(),i=this._getPoint(t);this._imgOffset={x:i.x-n.left,y:i.y-n.top},this._img.style.opacity=e._OPACITY.toString()}this._moveImage(t),document.body.appendChild(this._img)},e.prototype._destroyImage=function(){this._img&&this._img.parentElement&&this._img.parentElement.removeChild(this._img),this._img=null,this._imgCustom=null},e.prototype._moveImage=function(t){var e=this;this._img&&requestAnimationFrame(function(){var r=e._getPoint(t,!0),n=e._img.style;n.position="absolute",n.pointerEvents="none",n.zIndex="999999",n.left=Math.round(r.x-e._imgOffset.x)+"px",n.top=Math.round(r.y-e._imgOffset.y)+"px"})},e.prototype._copyProps=function(t,e,r){for(var n=0;n<r.length;n++){var i=r[n];t[i]=e[i]}},e.prototype._copyStyle=function(t,r){if(e._rmvAtts.forEach(function(t){r.removeAttribute(t)}),t instanceof HTMLCanvasElement){var n=t,i=r;i.width=n.width,i.height=n.height,i.getContext("2d").drawImage(n,0,0)}for(var s=getComputedStyle(t),a=0;a<s.length;a++){var o=s[a];o.indexOf("transition")<0&&(r.style[o]=s[o])}r.style.pointerEvents="none";for(var a=0;a<t.children.length;a++)this._copyStyle(t.children[a],r.children[a])},e.prototype._dispatchEvent=function(t,r,n){if(t&&n){var i=document.createEvent("Event"),s=t.touches?t.touches[0]:t;return i.initEvent(r,!0,!0),i.button=0,i.which=i.buttons=1,this._copyProps(i,t,e._kbdProps),this._copyProps(i,s,e._ptProps),i.dataTransfer=this._dataTransfer,n.dispatchEvent(i),i.defaultPrevented}return!1},e.prototype._closestDraggable=function(t){for(;t;t=t.parentElement)if(t.hasAttribute("draggable")&&t.draggable)return t;return null},e}();return e._instance=new e,e._THRESHOLD=5,e._OPACITY=.5,e._DBLCLICK=500,e._CTXMENU=900,e._rmvAtts="id,class,style,draggable".split(","),e._kbdProps="altKey,ctrlKey,metaKey,shiftKey".split(","),e._ptProps="pageX,pageY,clientX,clientY,screenX,screenY".split(","),e}),t("skylark-utils/transforms",["skylark-utils-dom/transforms"],function(t){return t}),t("skylark-utils/velm",["skylark-utils-dom/velm"],function(t){return t}),t("skylark-utils/widgets",["./skylark","./langx","./noder","./datax","./styler","./geom","./eventer","./query","./velm"],function(t,e,r,n,i,s,a,o,l){function u(){return u}function c(t,e,r){}var d=/^(\S+)\s*(.*)$/,h=(Array.prototype.slice,e.Evented.inherit({init:function(t,r){if(e.isHtmlNode(r)){var r=t;t=r}e.isHtmlNode(t)?this.el=t:this.el=null,r&&e.mixin(this,r),this.cid||(this.cid=e.uniqueId("w")),this._ensureElement()},tagName:"div",$:function(t){return this.$el.find(t)},render:function(){return this},remove:function(){return this._removeElement(),this.unlistenTo(),this},_removeElement:function(){this.$el.remove()},setElement:function(t){return this.undelegateEvents(),this._setElement(t),this.delegateEvents(),this},_setElement:function(t){this.$el=u.$(t),this.el=this.$el[0]},delegateEvents:function(t){if(t||(t=e.result(this,"events")),!t)return this;this.undelegateEvents();for(var r in t){var n=t[r];if(e.isFunction(n)||(n=this[n]),n){var i=r.match(d);this.delegate(i[1],i[2],e.proxy(n,this))}}return this},delegate:function(t,e,r){return this.$el.on(t+".delegateEvents"+this.uid,e,r),this},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.uid),this},undelegate:function(t,e,r){return this.$el.off(t+".delegateEvents"+this.uid,e,r),this},_createElement:function(t,e){return r.createElement(t,e)},_ensureElement:function(){if(this.el)this.setElement(e.result(this,"el"));else{var t=e.mixin({},e.result(this,"attributes"));this.id&&(t.id=e.result(this,"id")),this.className&&(t["class"]=e.result(this,"className")),this.setElement(this._createElement(e.result(this,"tagName"),t)),this._setAttributes(t)}},_setAttributes:function(t){this.$el.attr(t)},i18n:function(t,r){return t=this.messages&&this.messages[t]||t.toString(),r&&e.each(r,function(e,r){t=t.replace("{"+e+"}",r)}),t}}));return e.mixin(u,{$:o,define:c,Widget:h}),t.widgets=u}),t("skylark-utils/main",["./skylark","./browser","./css","./datax","./dnd","./devices","./eventer","./filer","./finder","./fx","./geom","./images","./models","./noder","./query","./scripter","./storages","./styler","./touchx","./transforms","./langx","./velm","./widgets"],function(t){return t}),t("skylark-utils",["skylark-utils/main"],function(t){return t})},this);
//# sourceMappingURL=sourcemaps/skylark-utils.js.map
